'use client';

import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';
import jsPDF from 'jspdf';
import { Slot } from "@radix-ui/react-slot"

export function DownloadReport({ reportContent, imagePreview, asChild, children }: { reportContent: string, imagePreview: string | null, asChild?: boolean, children?: React.ReactNode }) {

  const handleDownloadPdf = async () => {
    const doc = new jsPDF('p', 'pt', 'a4');
    const margin = 40;
    const footerHeight = 60; // Estimated height of the footer
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const usableWidth = pageWidth - margin * 2;
    const usableHeight = pageHeight - margin * 2 - footerHeight; // Reserve space for footer
    let y = margin;
    
    // Helper to add footer to every page
    const addFooter = (docInstance: jsPDF) => {
        const pageCount = docInstance.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            docInstance.setPage(i);
            const footerY = pageHeight - margin - footerHeight;

            docInstance.setFontSize(8);
            docInstance.setFont("helvetica", "bold");
            docInstance.text('AI Accuracy Disclaimer', margin, footerY + 10, { align: 'left' });
            
            docInstance.setFont("helvetica", "normal");
            const disclaimerText = "This report was generated by an AI and is for informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition.";
            const splitDisclaimer = docInstance.splitTextToSize(disclaimerText, usableWidth);
            docInstance.text(splitDisclaimer, margin, footerY + 22);
            
            const creatorText = "Created by Manuel M. in 2025 as a side hustle.";
            docInstance.text(creatorText, pageWidth / 2, pageHeight - margin + 10, { align: 'center'});
        }
    };

    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.text('XRay Insights - Diagnostic Report', pageWidth / 2, y, { align: 'center' });
    y += 30;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, y, { align: 'center' });
    y += 30;

    if (imagePreview) {
        try {
            const img = new Image();
            img.src = imagePreview;
            await new Promise(resolve => {
                img.onload = resolve;
            });
            const imgProps = doc.getImageProperties(img);
            const aspectRatio = imgProps.width / imgProps.height;
            let imgWidth = usableWidth * 0.6; // 60% of usable width
            let imgHeight = imgWidth / aspectRatio;
            
            const maxHeight = pageHeight * 0.3; // max 30% of page height
            if (imgHeight > maxHeight) {
                imgHeight = maxHeight;
                imgWidth = imgHeight * aspectRatio;
            }

            if (y + imgHeight > usableHeight) {
                doc.addPage();
                y = margin;
            }
            
            const x = (pageWidth - imgWidth) / 2;
            doc.addImage(img, 'PNG', x, y, imgWidth, imgHeight);
            y += imgHeight + 20;
        } catch (e) {
            console.error("Error adding image to PDF:", e);
        }
    }

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const lines = doc.splitTextToSize(reportContent, usableWidth);

    lines.forEach((line: string) => {
        let isHeader = false;
        let text = line;
        
        if (line.startsWith('## ')) {
            isHeader = true;
            text = line.substring(3);
        } else {
            text = line.replace(/-\s\*\*(.*?)\*\*: /g, '$1: ').replace(/\*\*/g, '');
        }
        
        const textHeight = (doc.getTextDimensions(text).h) + (isHeader ? 15 : 6);

        if (y + textHeight > usableHeight) {
            addFooter(doc);
            doc.addPage();
            y = margin;
        }

        if (isHeader) {
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            y += 10;
            doc.text(text, margin, y);
            y += 5;
            doc.line(margin, y, margin + usableWidth, y);
            y += 15;
        } else {
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(text, margin, y);
            y += 16;
        }
    });

    addFooter(doc);

    doc.save('diagnostic-report.pdf');
  };

  const Comp = asChild ? Slot : Button;

  return (
    <Comp onClick={handleDownloadPdf} {...(asChild ? {} : { variant: "outline", size: "sm" })}>
      {children ? children : (
        <>
          <Download className="mr-2" />
          Download as PDF
        </>
      )}
    </Comp>
  );
}
