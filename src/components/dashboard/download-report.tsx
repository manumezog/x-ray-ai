'use client';

import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';
import jsPDF from 'jspdf';

export function DownloadReport({ reportContent, imagePreview }: { reportContent: string, imagePreview: string | null }) {

  const handleDownloadPdf = async () => {
    const doc = new jsPDF('p', 'pt', 'a4');
    const margin = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const usableWidth = pageWidth - margin * 2;
    let y = margin;

    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.text('XRay Insights - Diagnostic Report', pageWidth / 2, y, { align: 'center' });
    y += 30;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, y, { align: 'center' });
    y += 30;

    if (imagePreview) {
        try {
            const img = new Image();
            img.src = imagePreview;
            await new Promise(resolve => {
                img.onload = resolve;
            });
            const imgProps = doc.getImageProperties(img);
            const aspectRatio = imgProps.width / imgProps.height;
            let imgWidth = usableWidth * 0.6; // 60% of usable width
            let imgHeight = imgWidth / aspectRatio;
            
            const maxHeight = pageHeight * 0.3; // max 30% of page height
            if (imgHeight > maxHeight) {
                imgHeight = maxHeight;
                imgWidth = imgHeight * aspectRatio;
            }
            
            const x = (pageWidth - imgWidth) / 2;
            doc.addImage(img, 'PNG', x, y, imgWidth, imgHeight);
            y += imgHeight + 20;
        } catch (e) {
            console.error("Error adding image to PDF:", e);
        }
    }

    const lines = reportContent.split('\n');
    lines.forEach(line => {
        if (y > pageHeight - margin * 2) {
            doc.addPage();
            y = margin;
        }

        if (line.startsWith('## ')) {
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            y += 10;
            const text = line.substring(3);
            const splitText = doc.splitTextToSize(text, usableWidth);
            doc.text(splitText, margin, y);
            y += (splitText.length * 14) + 5;
            doc.line(margin, y - 8, margin + usableWidth, y-8);
            y += 5;
        } else {
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const text = line.replace(/-\s\*\*(.*?)\*\*: /g, '$1: ').replace(/\*\*/g, '');
            const splitText = doc.splitTextToSize(text, usableWidth);
            doc.text(splitText, margin, y);
            y += splitText.length * 12;
        }
        y += 6;
    });
    
    // Position footer elements at the bottom
    const addFooter = (docInstance: jsPDF) => {
        const pageCount = docInstance.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            docInstance.setPage(i);
            const footerY = pageHeight - margin - 30;

            docInstance.setFontSize(8);
            docInstance.setFont("helvetica", "bold");
            docInstance.text('AI Accuracy Disclaimer', margin, footerY, { align: 'left' });
            
            docInstance.setFont("helvetica", "normal");
            const disclaimerText = "This report was generated by an AI and is for informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition.";
            const splitDisclaimer = docInstance.splitTextToSize(disclaimerText, usableWidth);
            docInstance.text(splitDisclaimer, margin, footerY + 10);
            
            const creatorText = "Created by Manuel M. in 2025 as a side hustle.";
            docInstance.text(creatorText, pageWidth / 2, pageHeight - margin + 10, { align: 'center'});
        }
    };
    
    addFooter(doc);

    doc.save('diagnostic-report.pdf');
  };

  return (
    <Button variant="outline" size="sm" onClick={handleDownloadPdf}>
      <Download className="mr-2" />
      Download as PDF
    </Button>
  );
}
